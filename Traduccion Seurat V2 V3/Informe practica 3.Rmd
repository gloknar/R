---
title: "Informe práctica 3"
author: "Adam Casas"
date: 'Compilado: `r format(Sys.Date(), "%d de %B del %Y")`'
output: 
  html_document:
    df_print: paged
    highlight: kate
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r configuracion_inicial, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F,
                      tidy = F)
##################################################
#######        Encoded in UTF-8        ###########
##################################################
```

***

# Integración de datasets de distintas especies con Análisis de Correlación Canónica (CCA)


En el trabajo de Butler _et al._ (2018) se muestran 2 datasets de scRNA-seq de páncreas: uno de humano y otro de ratón. Aplicaremos el análisis de correlación canónica (CCA) para integrar sendos datasets.


## 4.1 Carga de datos, normalización, escalado y CCA

Cargamos las matrices de conteos de los datasets de interés:

```{r}
human.data <- read.table("./Archivos accesorios/Codigo y datos de las Practicas 1-4/data/pancreas_human.expressionMatrix.txt", sep = "\t")

mouse.data <- read.table("./Archivos accesorios/Codigo y datos de las Practicas 1-4/data/pancreas_mouse.expressionMatrix.txt", sep = "\t")
```



Creamos los objetos `seurat`, normalizamos y escalamos los datos y detectamos genes diferencialmente expresados. Dado que las matrices de conteo de Butler _et al._ ya han filtrado las células mal secuenciadas, no tenemos que hacer ningún filtrado adicional.

```{r}
library(Seurat)
# Seurat V3.2 no es compatible con la ultima version de spatstat (2.0-1)
# install.packages('https://cran.r-project.org/src/contrib/Archive/spatstat/spatstat_1.64-1.tar.gz', repos=NULL,type="source")

# Objeto seurat del dataset humano
human <- CreateSeuratObject(counts = human.data)
human <- NormalizeData(human)
human <- ScaleData(human)
human <- FindVariableFeatures(human, selection.method = "mvp")

# Objeto seurat del dataset de ratón
mouse <- CreateSeuratObject(counts = mouse.data)
mouse <- NormalizeData(mouse)
mouse <- ScaleData(mouse)
mouse <- FindVariableFeatures(mouse, selection.method = "mvp")
```


Hecho eso, ahora obtenemos los genes diferencialmente expresados (DEGs o _Differentially Expressed Genes_) en humano, los DEGs de ratón y los agrupamos en un único objeto mediante el comando `union`.

```{r}
hvg.human <- VariableFeatures(human)
hvg.mouse <- VariableFeatures(mouse)
hvg.union <- union(hvg.human, hvg.mouse)

# Otra manera de obtener los genes diferencialmente expresados es obtenerlos del
# bolsillo `human/mouse[["RNA"]]@meta.features`:
# hvg.human <- rownames(head(human[["RNA"]]@meta.features, 1000))
# hvg.mouse <- rownames(head(mouse[["RNA"]]@meta.features, 1000))
```



Ahora escalamos los datos, con la particularidad de que esta vez ajustamos para la covariable confusora "Especie", codificada en la columna `orig.ident` del bolsillo `human/mouse@meta.data`. Tras ello crearemos una columna en los metadatos con información sobre la especie de la que provienen los datos:

```{r}
human <- ScaleData(human, vars.to.regress = "orig.ident", features = hvg.union)
mouse <- ScaleData(mouse, vars.to.regress = "orig.ident", features = hvg.union)

# Añadimos información sobre la especie de origen en los metadatos:
human@meta.data$species <- "human"
mouse@meta.data$species <- "mouse"

# Otra manera de crear la columna:
# human@meta.data[, "species"] <- "human"
# mouse@meta.data[, "species"] <- "mouse"
```



Ahora corremos el CCA para generar el objeto `seurat` combinado `pancreas.combined`:

```{r}
# CCA
pancreas.combined <- RunCCA(mouse, human, features = hvg.union)

# Seurat v2 usa `PrintDim` tal que así:
# PrintDim(pancreas.combined, reduction.type = "cca")
# mientras que Seurat V3 usa `print()` sobre la propia reducción:
print(pancreas.combined@reductions$cca, dims = 1:5, nfeatures = 30)


# Graficamos ambos datasets
DimPlot(pancreas.combined, reduction = "cca")
```


ejem

```{r}
# ¿Por qué hace esto?
pancreas.combined@meta.data[rownames(mouse@meta.data), "species"] <- "mouse"

# Seurat V2 usa `CalcVarExpRatio`; Seurat V3 usa...
pancreas.combined <- CalcVarExpRatio(pancreas.combined, reduction.type = "pca",
                                     grouping.var = "species", dims.use = 1:20)


pancreas.combined.all <- pancreas.combined




# Visualize the aligned datasets (before alignment)
pancreas.combined <-RunPCA(pancreas.combined , pc.genes = NULL, pcs.compute = 20,
use.imputed = FALSE, rev.pca = FALSE,
weight.by.var = TRUE, do.print = TRUE, pcs.print = 1:5,
genes.print = 30, reduction.name = "pca",
reduction.key = "PC", assay.type = "RNA", seed.use = 42)
```



```{r, eval = F}

pancreas.combined <- RunTSNE(pancreas.combined, reduction.use = "pca",
dims.use = 1:20, do.fast = T)
TSNEPlot(pancreas.combined, group.by = "species")
#-----
pancreas.combined <- SubsetData(pancreas.combined, subset.name = "var.ratio.pca",
accept.low = 0.5)
pancreas.combined <- AlignSubspace(pancreas.combined, reduction.type = "cca",
grouping.var = "species", dims.align = 1:20) #1:20
pancreas.combined <- RunTSNE(pancreas.combined, reduction.use = "cca.aligned",
dims.use = 1:20, do.fast = T)
# Visualize the aligned datasets
TSNEPlot(pancreas.combined, group.by = "species")
# Perform joint clustering
pancreas.combined <- FindClusters(pancreas.combined, reduction.type = "cca.aligned",
dims.use = 1:20, save.SNN = T)
# Visualize the clusters
TSNEPlot(pancreas.combined) # Cómando seurat?
# Finally, we can also plot the UMAP
pancreas.combined <- RunUMAP(pancreas.combined, reduction.use = "cca", dims.use = 1:20)
DimPlot(pancreas.combined , reduction.use = "umap", plot.title='UMAP (20 canonical
components)', pt.size=0.3, do.label=TRUE, do.return = TRUE)
```






<details>
<summary> __Ejercicio 3.1: Las células pancreáticas Beta (β) produce insulina (¿¿y las alfa y las Delta??). Puedes Identificar dichas células β en el _dataset___ </summary>


Consulta la info de gen como __PDX1__ en _Genecards_ o similares, y luego la _Proteómic Tissue Expression Atlas_ o coom se llame

Tip: Use gene marker, e.g. PDX1. 

<br>

__Solución:__


</details>





<br>

***

# sessionInfo()

<details>

<summary> Click para mostrar </summary>

```{r, echo = F}
sessionInfo()
```

</details>
