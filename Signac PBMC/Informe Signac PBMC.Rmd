---
title: "Análisis de datos scATAC-seq en Signac: 2700 PBMC"
author: "Adam Casas"
date: 'Compilado: `r format(Sys.Date(), "%d de %B del %Y")`'
output: 
  html_document:
    df_print: paged
    highlight: kate
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r configuracion_inicial, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F,
                      tidy = F)
set.seed(1)
##################################################
#######        Encoded in UTF-8        ###########
##################################################

```

***

# Instalación

Instalamos `Signac` en R versión 4.1:

```{r, eval = F}
BiocManager::install("Rsamtools")
install.packages("Signac")
```


https://satijalab.org/signac/articles/pbmc_vignette.html

# Introducción

`Signac` (Stuart _et al._, 2020) es una extensión del famoso paquete `Seurat` para explorar, analizar e interpretar datasets de scATAC-seq. ATAC-seq (y su variante de célula única) es, por decirlo de alguna manera, la sucesora espiritural de técnicas de secuenciacón como ChIP-seq y RRBS-Seq. Si en dichas técnicas se estudia el estado epigenético de las células/tejidos de interés, cierto es que se debe tener un conocimiento previo de cómo actúan los mecanismos epigenéticos del organismo en cuestión para poder sacarles el mayor rendimiento. __ATAC-seq__, por otro lado, evade dicha imposición al estudiar directamente la __accesibilidad de la cromatina__ a la transposasa hiperactiva Tn5 de manera "agnóstica" (sin necesidad de conocer _a priori_ los mecanismos epigenéticos subyacentes).


En este informe vamos a presentar `Signac` mediante el análisis del ya conocido dataset 2700 PBMC de [10x Genomics](https://www.10xgenomics.com/). Para ello debemos descargar primero los siguientes archivos (deberás descargarlos e instalarlos, pues pesan demasiado como para subirlos a GitHub): 

```{r, eval = F}
# El archivo con los datos crudos del ATAC-seq
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5")

# Sus metadatos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_singlecell.csv", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_singlecell.csv")

# El archivo de los fragmentos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_fragments.tsv.gz", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz")

# El archivo con el índice de los fragmentos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_fragments.tsv.gz.tbi", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz.tbi")
```



Ahora cargamos las librerías que vamos a usar:

```{r, message=F, warning=F}
library("Signac")
library("Seurat")
library("GenomeInfoDb")
# install.packages(pkgs = "http://bioconductor.org/packages/3.12/bioc/src/contrib/rtracklayer_1.50.0.tar.gz", repos = NULL, type = "source")
library("EnsDb.Hsapiens.v75")
# Gráficos
library("ggplot2")
library("patchwork")
```



***

<br>

# Preprocesado

`Signac` requiere dos archivos adicionales generados por el software _CellRanger_ para poder preprocesar datos de ATAC-Seq:

* __Peak/Cell matrix.__ La matriz de picos o células es similar a la matriz de expresión génica de dimensiones _genes_ x _células_ usada en scRNA-Seq. En ATAC-Seq la matriz es de _regiones cromosómicas_ x _células_. Cada valor de la matriz es el nº de sitios de integración de Tn5 en cada célula que mapean en dichas regiones o _peaks_.


* __Fragment file.__ Representa la lista completa de fragmentos únicos detectados en todas las células y es por tanto un archivo MUY pesado. Al ser tan pesado, se guarda en el disco duro en lugar de la RAM y a consecuencia manipularlo es un proceso lento. Su ventaja es que contiene todos los sitios de integración de Tn5 en cada célula.



Ya que `Signac` es una extensión de `Seurat`, vamos a trabajar con un objeto `Seurat` generado a partir de la __matriz de picos/célula__, sus __metadatos__ creados en `cellranger-atac` y el __archivo de fragmentos__.


```{r}
# Cargamos y visualizamos las 6 primeras filas de la matriz de ATAC_Seq en el objeto `matriz_picos_ATAC`:
matriz_picos_ATAC <- Read10X_h5("E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5")
head(matriz_picos_ATAC)

# En la matriz de picos/células, las filas son regiones cromosómicas y las
# columnas son células. Mide el grado de apertaura de la cromatina en las
# regiones cromosómica (nº de transposasas detectadas en dicha región para la
# célula de la columna)



metadatos <- read.csv(
  file = "E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_singlecell.csv",
  header = TRUE,
  row.names = 1)

head(metadatos)
class(metadatos)
dim(metadatos)
summary(metadatos)

hist(x = metadatos$peak_region_fragments, main = "Distribución de los peak region fragments", col = "turquoise")
boxplot(x= metadatos$peak_region_fragments)
min(metadatos$peak_region_fragments)

# Creamos el objeto de clase `ChromatinAssay` del ensayo/experimento de ATAC-Seq
ensayo_ATAC_Seq <- CreateChromatinAssay(
  counts = matriz_picos_ATAC,
  sep = c(":", "-"),
  genome = 'hg19',
  fragments = "E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz",
  min.cells = 10,
  min.features = 200)
class(ensayo_ATAC_Seq)

# Exploración del ensayo/experimento de ATAC-Seq
head(ensayo_ATAC_Seq)
class(ensayo_ATAC_Seq)
dim(ensayo_ATAC_Seq)

# Creamos el objeto Seurat a partir del susodicho ensayo
pbmc_Seurat <- CreateSeuratObject(
  counts = ensayo_ATAC_Seq,
  assay = "peaks",
  meta.data = metadatos)
pbmc_Seurat
pbmc_Seurat[['peaks']]
```


The ATAC-seq data is stored using a custom assay, the `ChromatinAssay.` This enables some specialized functions for analysing genomic single-cell assays such as scATAC-seq. By printing the assay we can see some of the additional information that can be contained in the ChromatinAssay, including motif information, gene annotations, and genome information. 

For example, we can call la función `granges()` on a Seurat object with a ChromatinAssay set as the active assay (or on a ChromatinAssay) to see the genomic ranges associated with each feature in the object. See the object interaction vignette for more information about the ChromatinAssay class.


```{r}
granges(pbmc_Seurat)
```

We can also add gene annotations to the pbmc object for the human genome. This will allow downstream functions to pull the gene annotation information directly from the object.

```{r}
# extract gene annotations from EnsDb
# BiocManager::install("biovizBase")
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75) # Este paso tarda mucho, creo que tira de internet

# change to UCSC style since the data was mapped to hg19
# seqlevelsStyle(annotations) <- "UCSC" # No funciona esta linea
supportedSeqlevelsStyle(annotations)

seqlevels(annotations)

genome(annotations) <- "hg19"

# add the gene information to the object
Annotation(pbmc_Seurat) <- annotations
```




***

<br>



# Métricas de calidad (QC)


We can now compute some QC metrics for the scATAC-seq experiment. We currently suggest the following metrics below to assess data quality. As with scRNA-seq, the expected range of values for these parameters will vary depending on your biological system, cell viability, and other factors.

 * Nucleosome banding pattern: The histogram of DNA fragment sizes (determined from the paired-end sequencing reads) should exhibit a strong nucleosome banding pattern corresponding to the length of DNA wrapped around a single nucleosome. We calculate this per single cell, and quantify the approximate ratio of mononucleosomal to nucleosome-free fragments (stored as nucleosome_signal)

 * Transcriptional start site (TSS) enrichment score. The ENCODE project has defined an ATAC-seq targeting score based on the ratio of fragments centered at the TSS to fragments in TSS-flanking regions (see https://www.encodeproject.org/data-standards/terms/). Poor ATAC-seq experiments typically will have a low TSS enrichment score. We can compute this metric for each cell with the TSSEnrichment() function, and the results are stored in metadata under the column name TSS.enrichment.

 * Total number of fragments in peaks: A measure of cellular sequencing depth / complexity. Cells with very few reads may need to be excluded due to low sequencing depth. Cells with extremely high levels may represent doublets, nuclei clumps, or other artefacts.

 * Fraction of fragments in peaks: Represents the fraction of all fragments that fall within ATAC-seq peaks. Cells with low values (i.e. <15-20%) often represent low-quality cells or technical artifacts that should be removed. Note that this value can be sensitive to the set of peaks used.

 * Ratio reads in genomic blacklist regions The ENCODE project has provided a list of blacklist regions, representing reads which are often associated with artefactual signal. Cells with a high proportion of reads mapping to these areas (compared to reads mapping to peaks) often represent technical artifacts and should be removed. ENCODE blacklist regions for human (hg19 and GRCh38), mouse (mm10), Drosophila (dm3), and C. elegans (ce10) are included in the Signac package.

Note that the last three metrics can be obtained from the output of CellRanger (which is stored in the object metadata), but can also be calculated for non-10x datasets using Signac (more information at the end of this document).


```{r}

```







<br>

<br>

## Normalization and linear dimensional reduction


[PH]



***

<br>

# Non-linear dimension reduction and clustering


[PH]




***

<br>

# Create a gene activity matrix


[PH]




***

<br>

# Integrating with scRNA-seq data


[PH]




***

<br>

# Find differentially accessible peaks between clusters



[PH]





***

<br>

# Plotting genomic regions


[PH]





***

<br>

# Bibliografía

* Stuart _et al._ Multimodal single-cell chromatin analysis with Signac. bioRxiv (2020).

* [PH]

* [PH]

* [PH]




***

<br>

# sessionInfo()

<details>

<summary> __Click para mostrar__ </summary>

```{r, echo = F}
sessionInfo()
```

</details>