---
title: "Análisis de datos scATAC-seq en Signac: 2700 PBMC"
author: "Adam Casas"
date: 'Compilado: `r format(Sys.Date(), "%d de %B del %Y")`'
output: 
  html_document:
    df_print: paged
    highlight: kate
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r configuracion_inicial, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F)
set.seed(1)
##################################################
#######        Encoded in UTF-8        ###########
##################################################
```

```{r Paralelizado protocolo, echo = F}
# Establecemos el límite de tamaño que puede usar `future` en 2 GBs dado que de
# lo contrario superamos el límite por defecto de 500 MBs al trabajar con objetos
# tan grandes
library("future")
plan(strategy = "multisession", workers = 4)
options(future.globals.maxSize = 2 * 1024^3)
```


***

# Instalación

Instalamos `Signac` en R versión 4.1:

```{r, eval = F}
BiocManager::install("Rsamtools")
install.packages("Signac")
```



***

<br>

# Introducción

`Signac` (Stuart _et al._, 2020) es una extensión del famoso paquete `Seurat` para explorar, analizar e interpretar datasets de scATAC-seq. ATAC-seq (y su variante de célula única) es, por decirlo de alguna manera, la sucesora espiritural de técnicas de secuenciacón como ChIP-seq y RRBS-Seq. Si en dichas técnicas se estudia el estado epigenético de las células/tejidos de interés, cierto es que se debe tener un conocimiento previo de cómo actúan los mecanismos epigenéticos del organismo en cuestión para poder sacarles el mayor rendimiento. __ATAC-seq__, por otro lado, evade dicha imposición al estudiar directamente la __accesibilidad de la cromatina__ a la transposasa hiperactiva Tn5 de manera "agnóstica" (sin necesidad de conocer _a priori_ los mecanismos epigenéticos subyacentes).


En este informe vamos a presentar `Signac` mediante el análisis del ya conocido dataset 2700 PBMC de [10x Genomics](https://www.10xgenomics.com/). Para ello debemos descargar primero los siguientes archivos (deberás descargarlos e instalarlos, pues pesan demasiado como para subirlos a GitHub): 

```{r, eval = F}
# El archivo con los datos crudos del ATAC-seq
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5")

# Sus metadatos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_singlecell.csv", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_singlecell.csv")

# El archivo de los fragmentos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_fragments.tsv.gz", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz")

# El archivo con el índice de los fragmentos
download.file("https://cf.10xgenomics.com/samples/cell-atac/1.0.1/atac_v1_pbmc_10k/atac_v1_pbmc_10k_fragments.tsv.gz.tbi", destfile = "./archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz.tbi")
```



Ahora cargamos las librerías que vamos a usar:

```{r, message=F, warning=F}
library("Signac")
library("Seurat")
library("GenomeInfoDb")
# install.packages(pkgs = "http://bioconductor.org/packages/3.12/bioc/src/contrib/rtracklayer_1.50.0.tar.gz", repos = NULL, type = "source")
library("EnsDb.Hsapiens.v75")
# Gráficos
library("ggplot2")
library("patchwork")
```


Paralelizamos el protocolo (usar con cuidado):

```{r}
# Establecemos el límite de tamaño que puede usar `future` en 2 GBs dado que de
# lo contrario superamos el límite por defecto de 500 MBs al trabajar con objetos
# tan grandes
plan(strategy = "multisession", workers = 4)
options(future.globals.maxSize = 2 * 1024^3)
```


***

<br>

# Preprocesado

`Signac` requiere dos archivos adicionales generados por el software _CellRanger_ para poder preprocesar datos de ATAC-Seq:

* __Peak/Cell matrix.__ La matriz de picos o células es similar a la matriz de expresión génica de dimensiones _genes_ x _células_ usada en scRNA-Seq. En ATAC-Seq la matriz es de _regiones cromosómicas_ x _células_. Cada valor de la matriz es el nº de sitios de integración de Tn5 en cada célula que mapean en dichas regiones o _peaks_.


* __Fragment file.__ Representa la lista completa de fragmentos únicos detectados en todas las células y es por tanto un archivo MUY pesado. Al ser tan pesado, se guarda en el disco duro en lugar de la RAM y a consecuencia manipularlo es un proceso lento. Su ventaja es que contiene todos los sitios de integración de Tn5 en cada célula.



Ya que `Signac` es una extensión de `Seurat`, vamos a trabajar con un objeto `Seurat` generado a partir de la __matriz de picos/célula__, sus __metadatos__ creados en `cellranger-atac` y el __archivo de fragmentos__.


```{r}
# Cargamos y visualizamos las 6 primeras filas de la matriz de ATAC_Seq en el objeto `matriz_picos_ATAC`:
matriz_picos_ATAC <- Read10X_h5("E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5")
matriz_picos_ATAC[c(1:5), c(1:5)]

# En la matriz de picos/células, las filas son regiones cromosómicas y las
# columnas son células. Mide el grado de apertaura de la cromatina en las
# regiones cromosómica (nº de transposasas detectadas en dicha región para la
# célula de la columna)



metadatos <- read.csv(
  file = "E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_singlecell.csv",
  header = TRUE,
  row.names = 1)

dim(metadatos)
head(metadatos)
summary(metadatos)

hist(x = metadatos$peak_region_fragments, main = "Distribución de los peak region fragments", col = "turquoise")
boxplot(x= metadatos$peak_region_fragments)
min(metadatos$peak_region_fragments)

# Creamos el objeto de clase `ChromatinAssay` del ensayo/experimento de ATAC-Seq
ensayo_ATAC_Seq <- CreateChromatinAssay(
  counts = matriz_picos_ATAC,
  sep = c(":", "-"),
  genome = 'hg19',
  fragments = "E:/Git/R/Signac PBMC/archivos_accesorios/atac_v1_pbmc_10k_fragments.tsv.gz",
  min.cells = 10,
  min.features = 200)

# Creamos el objeto Seurat a partir del susodicho ensayo
pbmc_Seurat <- CreateSeuratObject(
  counts = ensayo_ATAC_Seq,
  assay = "peaks",
  meta.data = metadatos)

pbmc_Seurat
pbmc_Seurat[['peaks']]
```


Los datos de la secuenciación ATAC se guardan en un objeto de tipo `ChromatinAssay`, el cual se caracteriza por presentar bolsillos para almacenar información adicional sobre motifs, anotaciones de los genes e información del genoma.  

Podemos usar la función `granges()` en un objeto de tipo `seurat` que tenga como experimento activo uno de tipo `ChromatinAssay` para observar las regiones cromosómicas asociada a cada feature (gen?) del objeto. Para más información sobre la clase `ChromatinAssay`, consulte la [viñeta de interacción con objetos](https://satijalab.org/signac/articles/data_structures.html).


```{r}
# Exploración del ensayo/experimento de ATAC-Seq
ensayo_ATAC_Seq
class(ensayo_ATAC_Seq)
dim(ensayo_ATAC_Seq)
granges(pbmc_Seurat)
```



También podemos añadir al objeto `pbmc_Seurat` las anotaciones del genoma humano para que ciertos comandos puedan hacer uso de dicha información. 

```{r, warning = F}
# Obtenemos las anotaciones del genoma humano hg19 desde Ensembl
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75, verbose = F) # Este paso es lento

# Cambiamos el estilo a "UCSC" dado que los datos fueron mapeados al genoma humano "hg19" 
# GenomeInfoDb::seqlevelsStyle(x = annotations) <-  "UCSC"
genome(annotations) <- "hg19"

# Añadimos las anotaciones al objeto de tipo `seurat`
Annotation(pbmc_Seurat) <- annotations

# seqinfo(pbmc_Seurat)
```





***

<br>

# Métricas de calidad (QC)


Ahora podemos comenzar con el control de calidad. Los creadores de `Signac` recomiendan prestar atención a las siguientes métricas: 

 * __Nucleosome banding pattern__: El histograma de los tamaños de los fragmentos de ADN (de secuencias paired-end, ojo) debe exhibir un marcado patrón de bandeo de nucleosomas correspondiente a la longitud del ADN enrollado alrededor de un único nucleosoma. Esta métrica se calcula mediante la siguiente ecuación:
 
$$nucleosome\ signal = \frac{fragmentos\_mononucleosomales}{fragmentos\_sin\_nucleosomas}$$

 * __Transcriptional start site (TSS) enrichment score__. El [proyecto ENCODE](https://www.encodeproject.org/data-standards/terms/) define el _TSS enrichment score_ como el ratio de fragmentos centrados en el TSS vs fragmentos flanqueantes al TSS. Los experimentos de ATAC-Seq mal hechos suelen tener un _TSS enrichment score_ bajo. Esta métrica se calcula para cada célula con el comando `TSSEnrichment()` y se almacena en los metadatos en la columna `TSS.enrichment`.

 * __Total number of fragments in peaks__: Las células con muy pocas lecturas se han secuenciado con poca profundidad y por tanto podemos eliminarlas del análisis. Células con muchas lecturas podrían ser _doublets_ (dos células secuenciadas como una), agregados de núcleos u otro tipo de artefactos.

 * __Fraction of fragments in peaks__: Representa el porcentaje de fragmentos (_i.e._ regiones cromosómicas) que caen en los picos de ATAC-seq. Las células con valores escasos (_i.e._ <15~20%) suelen ser células mal secuenciadas o artefactos técnicos (ruido) y por tanto se deberían eliminar. Tenga en cuenta que el umbral de rechazo de células depende del set de picos usado.

 * __Ratio reads in genomic blacklist regions__. The ENCODE project has provided a list of blacklist regions, representing reads which are often associated with artefactual signal. Cells with a high proportion of reads mapping to these areas (compared to reads mapping to peaks) often represent technical artifacts and should be removed. ENCODE blacklist regions for human (hg19 and GRCh38), mouse (mm10), Drosophila (dm3), and C. elegans (ce10) are included in the Signac package.

Téngase en cuenta que las métricas `Total number of fragments in peaks`, `Fraction of fragments in peaks` y `Ratio reads in genomic blacklist regions` pueden obtenerse del output de `CellRanger` de 10X Genomics. También es posible analizar datasets no-10XGenomics gracias a las utilidades que incorpora `Signac`.


```{r}
# compute nucleosome signal score per cell
pbmc_Seurat <- NucleosomeSignal(object = pbmc_Seurat)

# Calculamos el TSS enrichment compute TSS enrichment score per cell
# pbmc_Seurat <- TSSEnrichment(object = pbmc_Seurat, fast = FALSE)

# add blacklist ratio and fraction of reads in peaks
pbmc_Seurat$pct_reads_in_peaks <- pbmc_Seurat$peak_region_fragments / pbmc_Seurat$passed_filters * 100
pbmc_Seurat$blacklist_ratio <- pbmc_Seurat$blacklist_region_fragments / pbmc_Seurat$peak_region_fragments
```







<br>

<br>

## Normalization and linear dimensional reduction


[PH]



***

<br>

# Non-linear dimension reduction and clustering


[PH]




***

<br>

# Create a gene activity matrix


[PH]




***

<br>

# Integrating with scRNA-seq data


[PH]




***

<br>

# Find differentially accessible peaks between clusters



[PH]





***

<br>

# Plotting genomic regions


[PH]





***

<br>

# Bibliografía

* Stuart _et al._ Multimodal single-cell chromatin analysis with Signac. bioRxiv (2020).

* [PH]

* [PH]

* [PH]




***

<br>

# sessionInfo()

<details>

<summary> __Click para mostrar__ </summary>

```{r, echo = F}
sessionInfo()
```

</details>